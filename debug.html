<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç Firebase</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase SDK (Compat –≤–µ—Ä—Å–∏—è) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        input, button { padding: 10px; margin: 5px; font-size: 16px; }
        #messages { border: 1px solid #ccc; padding: 10px; min-height: 200px; margin-top: 10px; }
        .message { padding: 5px; margin: 5px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <h2>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç Firebase</h2>
    <div id="status">–°—Ç–∞—Ç—É—Å: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    
    <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    
    <h3>–°–æ–æ–±—â–µ–Ω–∏—è:</h3>
    <div id="messages"></div>

    <script>
        // –í–ê–®–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCfzfqOEXyO4f9w_WHfb5ba6VucR4C1h7Q",
            authDomain: "webrtc-chat-d4b03.firebaseapp.com",
            databaseURL: "https://webrtc-chat-d4b03-default-rtdb.firebaseio.com/",
            projectId: "webrtc-chat-d4b03",
            storageBucket: "webrtc-chat-d4b03.firebasestorage.app",
            messagingSenderId: "664462632968",
            appId: "1:664462632968:web:5908950ee288dde239c9bd"
        };

        let messagesRef;
        const TEST_ROOM = "simple_test_room_123"; // –ñ–µ—Å—Ç–∫–æ –∑–∞–¥–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∞

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            document.getElementById('status').innerText = "‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω";
            console.log("Firebase App:", firebase.app().options.projectId);

            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            const db = firebase.database();
            messagesRef = db.ref(`messages/${TEST_ROOM}`);
            document.getElementById('status').innerText = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –∫–æ–º–Ω–∞—Ç–µ: " + TEST_ROOM;
            console.log("Messages ref path:", messagesRef.toString());

            // –°–ª—É—à–∞—Ç–µ–ª—å –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            messagesRef.on('value', (snapshot) => {
                console.log("–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î:", snapshot.val());
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = "<p><em>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</em></p>";
                
                // –û—á–∏—Å—Ç–∏–º –∏ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                messagesDiv.innerHTML = "";
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    const msgElement = document.createElement('div');
                    msgElement.className = 'message';
                    msgElement.textContent = `[${new Date(data.timestamp || Date.now()).toLocaleTimeString()}] ${data.text || '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞'}`;
                    messagesDiv.appendChild(msgElement);
                });
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                document.getElementById('status').innerText = "‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã";
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:", error);
                document.getElementById('status').innerText = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: " + error.message;
            });

        } catch (error) {
            console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
            document.getElementById('status').innerText = "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: " + error.message;
        }

        function sendMessage() {
            const messageText = document.getElementById('message-input').value.trim();
            if (!messageText) {
                alert("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!");
                return;
            }
            if (!messagesRef) {
                alert("Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!");
                return;
            }

            try {
                messagesRef.push({
                    text: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP || Date.now(),
                    sender: "–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
                }).then(() => {
                    console.log("–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
                    document.getElementById('status').innerText = "üì§ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ";
                    document.getElementById('message-input').value = '';
                }).catch((error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                    document.getElementById('status').innerText = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message;
                });
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
                document.getElementById('status').innerText = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: " + error.message;
            }
        }
    </script>
</body>
</html>
