<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>Zombie Defense — одностраничная игра</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#111;color:#eee}
  #container{display:flex;height:100vh;}
  #game{flex:1;display:flex;align-items:stretch;justify-content:center;background: #0b0b0b;position:relative;}
  canvas{background: linear-gradient(#122,#0a0a0a); display:block; margin:auto; box-shadow: 0 0 20px #000}
  #ui{width:280px;min-width:260px;background:#141414;padding:12px;box-sizing:border-box;border-left: 2px solid #222;overflow:auto;}
  h2{margin:6px 0 10px 0;font-size:16px}
  .stat{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .bar{height:14px;background:#222;border-radius:7px;flex:1;overflow:hidden;position:relative}
  .bar > i{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(#f66,#c00)}
  .gold{color:#ffd24d;font-weight:bold}
  .btn{display:block;padding:8px;margin:6px 0;background:#1d1d1d;border:1px solid #333;color:#eee;text-align:center;cursor:pointer;border-radius:6px}
  .btn:hover{background:#272727}
  .shop-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px dashed #222}
  .muted{color:#aaa;font-size:12px}
  canvas::-webkit-focus-ring-color { outline: none; }
  #footer{font-size:12px;color:#999;margin-top:8px}
  .small{font-size:13px}

  /* Мобильные элементы управления */
  #mobileControls {
    position: absolute;
    bottom: 20px;
    left: 20px;
    z-index: 100;
    user-select: none;
  }
  .joystick {
    width: 120px;
    height: 120px;
    background: rgba(255,255,255,0.05);
    border-radius: 50%;
    position: relative;
    touch-action: none;
  }
  .joystick-knob {
    width: 50px;
    height: 50px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    position: absolute;
    left: 35px;
    top: 35px;
  }

  /* Кнопки стрельбы */
  #fireButtons {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 100;
  }
  .fire-btn {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    color: white;
    font-weight: bold;
    font-size: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    text-align: center;
    line-height: 80px;
    touch-action: none;
  }
  .fire-btn:active {
    background: rgba(255,255,255,0.3);
  }
</style>
</head>
<body>
<div id="container">
  <div id="game">
    <canvas id="c" width="900" height="600" tabindex="0"></canvas>

    <!-- Джойстик -->
    <div id="mobileControls">
      <div class="joystick" id="joystick">
        <div class="joystick-knob" id="joystickKnob"></div>
      </div>
    </div>

    <!-- Кнопки -->
    <div id="fireButtons">
      <div class="fire-btn" id="btnShoot">Fire</div>
      <div class="fire-btn" id="btnMagic">Magic</div>
    </div>
  </div>
  <div id="ui">
    <h2>Zombie Defense</h2>
    <div class="stat"><div>HP:</div><div class="bar" style="width:100%"><i id="hpbar" style="width:100%"></i></div><div id="hptext" style="width:60px;text-align:right">100 / 100</div></div>
    <div class="stat"><div>Gold:</div><div class="gold" id="gold">0</div></div>
    <div class="stat"><div>Wave:</div><div id="wave">0</div></div>
    <div class="stat"><div>Enemies:</div><div id="enemiesCount">0</div></div>

    <h2>Инвентарь & Оружие</h2>
    <div id="weapons" class="small">
      <div>Выбранное оружие: <b id="weaponName">Пистолет</b></div>
      <div class="muted">ЛКМ — стрелять | ПКМ — магия (огненный шар)</div>
      <div style="margin-top:8px">
        <button class="btn" id="buyBullets">Купить +10 патронов (10 золота)</button>
        <button class="btn" id="buyFood">Купить еду (восстановление 30 HP) — 15 золота</button>
      </div>
      <div style="margin-top:8px">
        <div>Патроны: <span id="ammo">30</span></div>
        <div>Еда в сумке: <span id="food">0</span></div>
        <div>Магия (фаербол) готова: <span id="magicReady">Да</span></div>
      </div>
    </div>

    <h2>Магазин / Постройка</h2>
    <div id="shop">
      <div class="shop-item"><div>Малая башня (авто-стрелок)</div><div><button class="btn" data-action="buyTower" data-cost="30">Купить 30</button></div></div>
      <div class="shop-item"><div>Средняя башня (мощнее)</div><div><button class="btn" data-action="buyTower" data-cost="70" data-power="2">Купить 70</button></div></div>
      <div class="shop-item"><div>Апгрейд урона (пистолет)</div><div><button class="btn" id="upgradeWeapon">Купить 50</button></div></div>
      <div class="shop-item"><div>Волна — начать</div><div><button class="btn" id="startWave">Старт волны</button></div></div>
    </div>

    <h2>Инструкции</h2>
    <div class="muted small">
      - Кликайте по земле, чтобы перемещаться.<br>
      - ЛКМ — стреляет по направлению к курсору (тратит патроны).<br>
      - ПКМ — магия (фаербол), имеет откат 8 с.<br>
      - Постройте башню — нажмите "Купить" в магазине, затем кликните по полю для размещения.<br>
      - Еда восстанавливает HP мгновенно.<br>
      - Зарабатывайте золото убивая зомби.
    </div>
    <div id="footer">Сделано в одном HTML • Простая демо-игра</div>
  </div>
</div>

<script>
/* --- Игра как в твоём коде, с добавлением джойстика и кнопок --- */
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  canvas.focus();

  // UI refs
  const hpbar = document.getElementById('hpbar');
  const hptext = document.getElementById('hptext');
  const goldEl = document.getElementById('gold');
  const waveEl = document.getElementById('wave');
  const enemiesCountEl = document.getElementById('enemiesCount');
  const ammoEl = document.getElementById('ammo');
  const foodEl = document.getElementById('food');
  const magicReadyEl = document.getElementById('magicReady');
  const weaponNameEl = document.getElementById('weaponName');

  const W = canvas.width, H = canvas.height;
  let gold = 50, wave = 0;
  let enemies = [], projectiles = [], towers = [], particles = [];
  let placingTower = null;
  let mouse = {x:0,y:0,down:false,rightDown:false};
  let lastTime = 0;

  const player = {x:W/2, y:H/2, r:14, hpMax:100, hp:100, speed:200, ammo:30, food:0, weaponPower:1, magicCooldown:0, magicReady:true};

  const config = {enemyBaseHealth:20, enemySpeed:40, spawnPerWaveBase:6, goldPerKill:6, towerFireRate:0.8, towerRange:140, timeScale:1};

  function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y) }
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)) }
  function rand(min,max){ return Math.random()*(max-min)+min }
  function now(){ return performance.now()/1000 }

  canvas.addEventListener('mousemove', e=> {
    const rect = canvas.getBoundingClientRect();
    mouse.x = (e.clientX - rect.left) * (canvas.width / rect.width);
    mouse.y = (e.clientY - rect.top) * (canvas.height / rect.height);
  });
  canvas.addEventListener('mousedown', e=> {
    if(e.button===0) mouse.down = true;
    if(e.button===2) mouse.rightDown = true;
    if(placingTower && e.button===0){
      if(gold>=placingTower.cost && dist(mouse,player)>50){
        towers.push({x:mouse.x,y:mouse.y,range:(placingTower.power||1)*config.towerRange,fireRate:config.towerFireRate/(placingTower.power||1),lastFire:0,power:(placingTower.power||1),hp:60+(placingTower.power||0)*40});
        gold -= placingTower.cost;
        placingTower=null;
      }
    }
  });
  canvas.addEventListener('mouseup', e=> {
    if(e.button===0) mouse.down=false;
    if(e.button===2){ mouse.rightDown=false; castMagic(); }
  });
  canvas.addEventListener('contextmenu', e=> e.preventDefault());

  document.getElementById('buyBullets').addEventListener('click', ()=>{ if(gold>=10){ gold-=10; player.ammo+=10; updateUI(); } });
  document.getElementById('buyFood').addEventListener('click', ()=>{ if(gold>=15){ gold-=15; player.food++; updateUI(); } });
  document.querySelectorAll('[data-action="buyTower"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ placingTower={cost:+btn.dataset.cost||30, power:+btn.dataset.power||1}; });
  });
  document.getElementById('upgradeWeapon').addEventListener('click', ()=>{ if(gold>=50){ gold-=50; player.weaponPower++; updateUI(); } });
  document.getElementById('startWave').addEventListener('click', ()=> startWave());

  function shoot(tx,ty,opts={}) {
    if(player.ammo<=0) return;
    player.ammo--;
    const angle = Math.atan2(ty-player.y, tx-player.x);
    projectiles.push({x:player.x,y:player.y,vx:Math.cos(angle)*(opts.speed||600),vy:Math.sin(angle)*(opts.speed||600),r:4,dmg:(opts.dmg||12)*player.weaponPower,ttl:2});
  }
  function castMagic(){
    if(!player.magicReady||player.magicCooldown>0) return;
    player.magicReady=false; player.magicCooldown=8;
    const angle = Math.atan2(mouse.y-player.y, mouse.x-player.x);
    projectiles.push({x:player.x,y:player.y,vx:Math.cos(angle)*420,vy:Math.sin(angle)*420,r:10,dmg:45,ttl:2.2,magic:true});
  }
  function spawnEnemy(x,y,hp,spd){ enemies.push({x,y,r:12,hp,maxHp:hp,speed:spd,target:player}); }
  function startWave(){
    wave++; waveEl.textContent=wave;
    const count = config.spawnPerWaveBase + wave*2;
    for(let i=0;i<count;i++){
      const edge = Math.floor(Math.random()*4);
      let x,y; if(edge===0){x=-20;y=rand(0,H)} if(edge===1){x=W+20;y=rand(0,H)} if(edge===2){x=rand(0,W);y=-20} if(edge===3){x=rand(0,W);y=H+20}
      const hp = config.enemyBaseHealth + wave*6 + Math.random()*10;
      const spd = config.enemySpeed + wave*2 + Math.random()*10;
      setTimeout(()=> spawnEnemy(x,y,hp,spd), i*350);
    }
  }

  // Джойстик
  let joystickActive=false, joystickCenter={x:0,y:0}, joystickVector={x:0,y:0};
  const joystick = document.getElementById('joystick');
  const joystickKnob = document.getElementById('joystickKnob');
  function onJoystickStart(e){ e.preventDefault(); joystickActive=true; const rect=joystick.getBoundingClientRect(); joystickCenter={x:rect.left+rect.width/2,y:rect.top+rect.height/2}; }
  function onJoystickMove(e){ if(!joystickActive) return; const t=e.touches?e.touches[0]:e; const dx=t.clientX-joystickCenter.x, dy=t.clientY-joystickCenter.y; const dist=Math.min(Math.hypot(dx,dy),40); const ang=Math.atan2(dy,dx); joystickVector.x=Math.cos(ang)*(dist/40); joystickVector.y=Math.sin(ang)*(dist/40); joystickKnob.style.transform=`translate(${joystickVector.x*40}px,${joystickVector.y*40}px)`; }
  function onJoystickEnd(){ joystickActive=false; joystickVector.x=joystickVector.y=0; joystickKnob.style.transform=`translate(0,0)`; }
  joystick.addEventListener('touchstart',onJoystickStart); joystick.addEventListener('touchmove',onJoystickMove); joystick.addEventListener('touchend',onJoystickEnd);
  joystick.addEventListener('mousedown',onJoystickStart); window.addEventListener('mousemove',onJoystickMove); window.addEventListener('mouseup',onJoystickEnd);

  // Кнопки
  document.getElementById('btnShoot').addEventListener('touchstart',()=> shoot(mouse.x,mouse.y,{dmg:12,speed:700}));
  document.getElementById('btnShoot').addEventListener('mousedown',()=> shoot(mouse.x,mouse.y,{dmg:12,speed:700}));
  document.getElementById('btnMagic').addEventListener('touchstart',()=> castMagic());
  document.getElementById('btnMagic').addEventListener('mousedown',()=> castMagic());

  function update(dt){
    if(joystickVector.x||joystickVector.y){
      player.x += joystickVector.x * player.speed * dt;
      player.y += joystickVector.y * player.speed * dt;
    }
    updateUI();
  }
  function updateUI(){
    hpbar.style.width = (player.hp/player.hpMax*100)+'%';
    hptext.textContent=Math.round(player.hp)+' / '+player.hpMax;
    goldEl.textContent=Math.round(gold);
    waveEl.textContent=wave;
    enemiesCountEl.textContent=enemies.length;
    ammoEl.textContent=player.ammo;
    foodEl.textContent=player.food;
    magicReadyEl.textContent=player.magicReady ? 'Да' : Math.ceil(player.magicCooldown)+'с';
    weaponNameEl.textContent=player.weaponPower>1 ? `Пистолет +${player.weaponPower-1}` : 'Пистолет';
  }
  function draw(){
    const time=now();
    let dt=lastTime?(time-lastTime):0; lastTime=time; dt=Math.min(dt,0.05);
    update(dt);
    ctx.clearRect(0,0,W,H);
    requestAnimationFrame(draw);
  }
  startWave();
  requestAnimationFrame(draw);
})();
</script>
</body>
</html>
